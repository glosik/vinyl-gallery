<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vinyl Collection Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; background: #f9f9f9; }
    header { margin-bottom: 1rem; }
    .filters { display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .filter-group label { font-size: 0.9rem; font-weight: bold; color: #333; }
    select, input { padding: 0.5rem; font-size: 1rem; border: 1px solid #ddd; border-radius: 4px; }
    input { min-width: 200px; }
    button { padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
    button:hover { background: #c82333; }
    @media (max-width: 768px) { .filters { flex-direction: column; align-items: stretch; } input { min-width: auto; } }
    #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .album-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; text-align: center; padding: 0.5rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .album-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .album-card img { width: 100%; height: auto; display: block; border-bottom: 1px solid #eee; }
    .album-card p { margin: 0.5rem 0 0; font-size: 0.9rem; }
    .value { color: #28a745; font-weight: bold; font-size: 0.9rem; margin: 0.25rem 0; }
    .value::before { content: "ðŸ’Ž "; }
  </style>
</head>
<body>
  <header>
    <h1>Vinyl Collection Viewer</h1>
    <div class="filters">
      <div class="filter-group">
        <label for="format">Format:</label>
        <select id="format">
          <option value="">-- Select --</option>
          <option value="vinyl" selected>Vinyl</option>
          <option value="cd">CD</option>
          <option value="cassette">Cassette</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="genre">Genre:</label>
        <select id="genre">
          <option value="">All Genres</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="value">Min Value:</label>
        <select id="value">
          <option value="">Any Value</option>
          <option value="450">450+ Value</option>
          <option value="400">400+ Value</option>
          <option value="350">350+ Value</option>
          <option value="300">300+ Value</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="search">Search:</label>
        <input type="text" id="search" placeholder="Artist or album title...">
      </div>
      
      <button id="clear-filters">Clear Filters</button>
    </div>
  </header>
  <div id="gallery"></div>

  <script>
    const gallery = document.getElementById("gallery");
    const formatSelect = document.getElementById("format");
    const genreSelect = document.getElementById("genre");
    const valueSelect = document.getElementById("value");
    const searchInput = document.getElementById("search");
    const clearButton = document.getElementById("clear-filters");
    
    const slug = str => str.toLowerCase().replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-");
    
    let allAlbums = [];
    let currentFormat = "vinyl";

    async function loadAllAlbums(format) {
      if (!format) {
        allAlbums = [];
        return;
      }
      
      gallery.innerHTML = "<p>Loading...</p>";
      allAlbums = [];

      try {
        // Load all decades for the format
        const decades = ['1980s', '1990s', '2000s', '2010s'];
        
        for (const decade of decades) {
          try {
            const res = await fetch(`data/${format}/${decade}.json`);
            if (res.ok) {
              const albums = await res.json();
              allAlbums.push(...albums.map(album => ({ ...album, format, decade })));
            }
          } catch (e) {
            // Continue to next decade if file doesn't exist
          }
        }
        
        updateGenreFilter();
        filterAndDisplayAlbums();
      } catch (err) {
        gallery.innerHTML = "<p>Failed to load albums.</p>";
        console.error(err);
      }
    }

    function updateGenreFilter() {
      const genres = [...new Set(allAlbums.map(album => album.genre).filter(Boolean))].sort();
      genreSelect.innerHTML = '<option value="">All Genres</option>';
      genres.forEach(genre => {
        const option = document.createElement('option');
        option.value = genre;
        option.textContent = genre;
        genreSelect.appendChild(option);
      });
    }

    function filterAndDisplayAlbums() {
      const genreFilter = genreSelect.value;
      const valueFilter = parseFloat(valueSelect.value) || 0;
      const searchFilter = searchInput.value.toLowerCase();

      let filteredAlbums = allAlbums.filter(album => {
        const matchesGenre = !genreFilter || album.genre === genreFilter;
        const matchesValue = !valueFilter || (album.value && album.value >= valueFilter);
        const matchesSearch = !searchFilter || 
          album.title.toLowerCase().includes(searchFilter) || 
          album.artist.toLowerCase().includes(searchFilter);
        
        return matchesGenre && matchesValue && matchesSearch;
      });

      displayAlbums(filteredAlbums);
    }

    function displayAlbums(albums) {
      if (albums.length === 0) {
        gallery.innerHTML = "<p>No albums match your filters.</p>";
        return;
      }

      gallery.innerHTML = "";
      albums.forEach(({ id, title, artist, year, genre, label, image, value, format }) => {
        const filename = image || `${slug(title)}_${slug(artist)}-${format}.jpg`;
        const card = document.createElement("div");
        card.className = "album-card";
        card.onclick = () => window.location.href = `album.html?id=${id}&format=${format}`;
        card.innerHTML = `
          <img src="images/${format}/${filename}" alt="${title} by ${artist}" loading="lazy">
          <p><strong>${title}</strong><br>${artist} (${year})</p>
          ${genre ? `<p style="font-size: 0.8rem; color: #666;">${genre}</p>` : ''}
          ${value ? `<div class="value">${value}</div>` : ''}
        `;
        gallery.appendChild(card);
      });
    }

    function clearFilters() {
      genreSelect.value = "";
      valueSelect.value = "";
      searchInput.value = "";
      filterAndDisplayAlbums();
    }

    // Event listeners
    formatSelect.addEventListener("change", e => {
      currentFormat = e.target.value;
      loadAllAlbums(currentFormat);
    });

    genreSelect.addEventListener("change", filterAndDisplayAlbums);
    valueSelect.addEventListener("change", filterAndDisplayAlbums);
    searchInput.addEventListener("input", filterAndDisplayAlbums);
    clearButton.addEventListener("click", clearFilters);

    // Load vinyl records on page load
    document.addEventListener("DOMContentLoaded", () => {
      loadAllAlbums("vinyl");
    });
  </script>
</body>
</html>
